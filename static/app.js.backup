// Global variables
let variablesEditor, templateEditor;
let uploadedData = null;
let currentTemplateId = null;
let currentTemplateVersion = null;
let isEditMode = false;
let allTemplates = [];
let generatedConfigs = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initializeJinjaTester();
    initializeTemplateManager();
    setupDragAndDrop();
});

// ========== Tab Switching ==========
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');

    // Refresh editors if switching to jinja-tester
    if (tabName === 'jinja-tester' && variablesEditor && templateEditor) {
        setTimeout(() => {
            variablesEditor.refresh();
            templateEditor.refresh();
        }, 100);
    }
}

// ========== Jinja Tester Tab ==========
function initializeJinjaTester() {
    // Initialize CodeMirror editors
    variablesEditor = CodeMirror.fromTextArea(document.getElementById('variables'), {
        mode: 'yaml',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2
    });

    templateEditor = CodeMirror.fromTextArea(document.getElementById('template'), {
        mode: 'jinja2',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2
    });

    const outputContainer = document.getElementById('output-container');
    const errorContainer = document.getElementById('template-error-container');

    let renderInProgress = false;
    let renderQueued = false;

    // HTML escape function
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Syntax highlighting for network configs (SecureCRT style)
    function highlightNetworkConfig(line) {
        const trimmed = line.trim();

        if (!trimmed) return escapeHtml(line);
        // Highlight switch separator lines (##### SWITCH_NAME #####)
        if (trimmed.match(/^#{3,}.*#{3,}$/)) {
            return `<div style="color: #00ff00; font-weight: bold; font-size: 1.1em; background: rgba(0, 255, 0, 0.1); padding: 8px; margin: 10px 0; border-left: 4px solid #00ff00; border-radius: 3px;">${escapeHtml(line)}</div>`;
        }
        if (trimmed === '!' || trimmed.startsWith('#')) {
            return `<span style="color: #808080;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^interface\s+/i)) {
            return `<span style="color: #00d7ff; font-weight: bold;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*description\s+/i)) {
            return `<span style="color: #00ff00;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*ip\s+(address|route)/i)) {
            const highlighted = escapeHtml(line).replace(/(\d+\.\d+\.\d+\.\d+)/g,
                '<span style="color: #ffff00;">$1</span>');
            return `<span style="color: #d4d4d4;">${highlighted}</span>`;
        }
        if (trimmed.match(/^\s*switchport/i)) {
            return `<span style="color: #ff00ff;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*(vlan|encapsulation)/i)) {
            const highlighted = escapeHtml(line).replace(/\b(\d+)\b/g,
                '<span style="color: #ffa500;">$1</span>');
            return `<span style="color: #ff8c00;">${highlighted}</span>`;
        }
        if (trimmed.match(/^\s*(channel-group|vpc|port-channel)/i)) {
            return `<span style="color: #87ceeb;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*spanning-tree/i)) {
            return `<span style="color: #90ee90;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*no\s+shutdown/i)) {
            return `<span style="color: #00ff00; font-weight: bold;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*shutdown/i)) {
            return `<span style="color: #ff0000; font-weight: bold;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*ptp/i)) {
            return `<span style="color: #dda0dd;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^(router|vrf)/i)) {
            return `<span style="color: #00ffff; font-weight: bold;">${escapeHtml(line)}</span>`;
        }

        return `<span style="color: #d4d4d4;">${escapeHtml(line)}</span>`;
    }

    async function renderTemplate() {
        if (renderInProgress) {
            renderQueued = true;
            return;
        }

        renderInProgress = true;
        const template = templateEditor.getValue();
        const variables = variablesEditor.getValue();

        errorContainer.innerHTML = '';
        templateEditor.getWrapperElement().classList.remove('error-highlight');

        if (!template && !variables) {
            outputContainer.textContent = '';
            renderInProgress = false;
            return;
        }

        try {
            const response = await fetch('/render', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({template, variables})
            });

            const data = await response.json();

            if (data.success) {
                const lines = data.output.trim().split('\n');
                const filteredLines = lines.filter(line => line.trim() !== '');
                const highlightedLines = filteredLines.map(line => highlightNetworkConfig(line));
                outputContainer.innerHTML = highlightedLines.join('\n');
            } else {
                outputContainer.textContent = '‚ö†Ô∏è Error:\n' + data.error;
                outputContainer.style.color = '#ff9800';
                errorContainer.innerHTML = '<div class="error-message">‚ö†Ô∏è ' + data.error + '</div>';
                templateEditor.getWrapperElement().classList.add('error-highlight');
                setTimeout(() => {
                    templateEditor.getWrapperElement().classList.remove('error-highlight');
                }, 300);
            }
        } catch (error) {
            outputContainer.textContent = '‚ö†Ô∏è Connection Error:\n' + error.message;
            outputContainer.style.color = '#ff9800';
        }

        renderInProgress = false;

        if (renderQueued) {
            renderQueued = false;
            setTimeout(renderTemplate, 0);
        }
    }

    variablesEditor.on('change', renderTemplate);
    templateEditor.on('change', renderTemplate);
    renderTemplate();
}

// ========== Config Generator Tab ==========
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('fileInput').files = files;
            handleFileUpload({target: {files}});
        }
    });
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/upload-excel', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Sort data by switch name, then by eth_port
            const sortedData = sortDataByPortOrder(result.data);
            uploadedData = sortedData;

            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.disabled = false;
            document.getElementById('uploadArea').innerHTML = `
                <div class="upload-icon">‚úÖ</div>
                <div style="color: #4caf50; font-size: 1.1em; margin-bottom: 8px;">
                    File uploaded successfully: ${file.name}
                </div>
                <div style="color: #999; font-size: 0.9em;">
                    ${result.data.length} rows loaded
                </div>
                <div style="margin-top: 15px;">
                    <button class="button button-secondary" onclick="resetUploadArea()" style="font-size: 0.9em;">
                        üîÑ RESET
                    </button>
                </div>
            `;

            // Display editable preview table
            displayEditablePreview(sortedData, result.columns);
        } else {
            alert('Error uploading file: ' + result.error);
        }
    } catch (error) {
        alert('Error uploading file: ' + error.message);
    }
}

function sortDataByPortOrder(data) {
    // Create a copy to avoid mutating the original
    const sortedData = [...data];

    // Helper function to extract numeric value from port string
    function extractPortNumber(portStr) {
        if (!portStr) return 0;
        // Handle formats like "Ethernet1/1", "eth1/1", "1/1", "1", etc.
        const match = String(portStr).match(/(\d+)\/(\d+)|(\d+)/);
        if (match) {
            if (match[1] && match[2]) {
                // Format: "1/1" - use slot*1000 + port for proper ordering
                return parseInt(match[1]) * 1000 + parseInt(match[2]);
            } else if (match[3]) {
                // Format: "1" - just the number
                return parseInt(match[3]);
            }
        }
        return 0;
    }

    sortedData.sort((a, b) => {
        // First sort by switch name
        const switchA = String(a.switch_name || a.hostname || '').toLowerCase();
        const switchB = String(b.switch_name || b.hostname || '').toLowerCase();

        if (switchA < switchB) return -1;
        if (switchA > switchB) return 1;

        // If switch names are equal, sort by eth_port
        const portA = extractPortNumber(a.eth_port || a.port || a.interface);
        const portB = extractPortNumber(b.eth_port || b.port || b.interface);

        return portA - portB;
    });

    return sortedData;
}

function displayEditablePreview(data, columns) {
    const previewContainer = document.getElementById('dataPreview');
    if (!previewContainer) return;

    if (!data || data.length === 0) {
        previewContainer.innerHTML = '<div class="info-box">No data to preview</div>';
        return;
    }

    let tableHTML = '<div style="padding: 20px; padding-top: 0;"><table class="preview-table" style="width: 100%; border-collapse: collapse; background: #1e1e1e;">';

    // Header
    tableHTML += '<thead><tr style="position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.5);">';
    tableHTML += `<th style="padding: 10px; border: 1px solid #444; border-bottom: 2px solid #667eea; color: #999; font-weight: bold; text-align: center; width: 50px; background: #252526;">#</th>`;
    columns.forEach(col => {
        tableHTML += `<th style="padding: 10px; border: 1px solid #444; border-bottom: 2px solid #667eea; color: #fff; font-weight: bold; text-align: center; background: #2d2d30;">${escapeHtml(col)}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    // Data rows
    data.forEach((row, rowIndex) => {
        tableHTML += '<tr>';
        // Line number column
        tableHTML += `<td style="padding: 8px; border: 1px solid #444; text-align: center; color: #999; background: #1a1a1a; font-family: 'Consolas', monospace; font-size: 0.85em;">${rowIndex + 1}</td>`;
        columns.forEach(col => {
            const value = row[col] !== undefined && row[col] !== null ? row[col] : '';
            tableHTML += `<td style="padding: 8px; border: 1px solid #444; text-align: center;">
                <input type="text"
                       class="cell-input"
                       data-row="${rowIndex}"
                       data-col="${escapeHtml(col)}"
                       value="${escapeHtml(String(value))}"
                       style="width: 100%; background: transparent; border: none; color: #ccc; padding: 4px; font-family: 'Consolas', monospace; font-size: 0.9em; text-align: center;"
                       onchange="handleCellEdit(${rowIndex}, '${escapeHtml(col)}', this.value)">
            </td>`;
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table></div>';
    previewContainer.innerHTML = tableHTML;
}

async function handleCellEdit(rowIndex, column, value) {
    if (!uploadedData || !uploadedData[rowIndex]) return;

    // Update the data
    uploadedData[rowIndex][column] = value;
}

async function generateConfigs() {
    if (!uploadedData) {
        return;
    }

    try {
        const response = await fetch('/api/generate-configs', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({excel_data: uploadedData})
        });

        const result = await response.json();

        if (result.success) {
            generatedConfigs = result.configs;
            displayConfigs(result.configs);
        } else {
            alert('Error generating configs: ' + result.error);
        }
    } catch (error) {
        alert('Error generating configs: ' + error.message);
    }
}

function displayConfigs(configs) {
    const resultsContainer = document.getElementById('configResults');

    if (configs.length === 0) {
        resultsContainer.innerHTML = '<div class="info-box">No configs generated</div>';
        return;
    }

    // Helper function for syntax highlighting
    function highlightNetworkConfig(line) {
        const trimmed = line.trim();

        if (!trimmed) return escapeHtml(line);
        // Highlight switch separator lines (##### SWITCH_NAME #####)
        if (trimmed.match(/^#{3,}.*#{3,}$/)) {
            return `<div style="color: #00ff00; font-weight: bold; font-size: 1.1em; background: rgba(0, 255, 0, 0.1); padding: 8px; margin: 10px 0; border-left: 4px solid #00ff00; border-radius: 3px;">${escapeHtml(line)}</div>`;
        }
        if (trimmed === '!' || trimmed.startsWith('#')) {
            return `<span style="color: #808080;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^interface\s+/i)) {
            return `<span style="color: #00d7ff; font-weight: bold;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*description\s+/i)) {
            return `<span style="color: #00ff00;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*ip\s+(address|route)/i)) {
            const highlighted = escapeHtml(line).replace(/(\d+\.\d+\.\d+\.\d+)/g,
                '<span style="color: #ffff00;">$1</span>');
            return `<span style="color: #d4d4d4;">${highlighted}</span>`;
        }
        if (trimmed.match(/^\s*switchport/i)) {
            return `<span style="color: #ff00ff;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*(vlan|encapsulation)/i)) {
            const highlighted = escapeHtml(line).replace(/\b(\d+)\b/g,
                '<span style="color: #ffa500;">$1</span>');
            return `<span style="color: #ff8c00;">${highlighted}</span>`;
        }
        if (trimmed.match(/^\s*(channel-group|vpc|port-channel)/i)) {
            return `<span style="color: #87ceeb;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*spanning-tree/i)) {
            return `<span style="color: #90ee90;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*no\s+shutdown/i)) {
            return `<span style="color: #00ff00; font-weight: bold;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*shutdown/i)) {
            return `<span style="color: #ff0000; font-weight: bold;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^\s*ptp/i)) {
            return `<span style="color: #dda0dd;">${escapeHtml(line)}</span>`;
        }
        if (trimmed.match(/^(router|vrf)/i)) {
            return `<span style="color: #00ffff; font-weight: bold;">${escapeHtml(line)}</span>`;
        }

        return `<span style="color: #d4d4d4;">${escapeHtml(line)}</span>`;
    }

    // Collect all successful configs into a single output
    const successConfigs = configs.filter(c => c.success);
    const errorConfigs = configs.filter(c => !c.success);

    if (successConfigs.length === 0) {
        // Only errors
        resultsContainer.innerHTML = `
            <div class="info-box" style="background: #3d1f1f; border-color: #f44336;">
                <div style="color: #f44336; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è Configuration Generation Errors</div>
                ${errorConfigs.map(config => `
                    <div style="margin-bottom: 10px; padding: 8px; background: #2d1515; border-radius: 4px;">
                        <div style="color: #ff8080; font-size: 0.9em; margin-bottom: 4px;">
                            ${config.row.host_type || 'N/A'}/${config.row.port_type || 'N/A'}/${config.row.switch_os || 'N/A'}
                        </div>
                        <div style="color: #ffcccc; font-size: 0.85em;">${config.error}</div>
                    </div>
                `).join('')}
            </div>
        `;
        return;
    }

    // Combine all configs into one output (just the config content, no separators)
    const combinedConfig = successConfigs.map(config => config.config).join('\n');

    // Clean up excessive blank lines for clipboard copy - replace 2 or more blank lines with single blank line
    const cleanedConfig = combinedConfig.replace(/\n\s*\n\s*\n+/g, '\n\n').trim();

    // Apply syntax highlighting - keep single blank lines but remove excessive ones
    const lines = cleanedConfig.split('\n');
    const highlightedLines = lines.map(line => highlightNetworkConfig(line));

    // Display in a single textbox-style output
    resultsContainer.innerHTML = `
        <div style="margin-bottom: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="button button-secondary" onclick="copyConfigToClipboard()">Copy</button>
        </div>
        <div class="config-output" style="max-height: calc(100vh - 250px); overflow-y: auto;">
            ${highlightedLines.join('\n')}
        </div>
        ${errorConfigs.length > 0 ? `
            <div class="info-box" style="background: #3d1f1f; border-color: #f44336; margin-top: 15px;">
                <div style="color: #f44336; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è Some rows had errors:</div>
                ${errorConfigs.map(config => `
                    <div style="margin-bottom: 10px; padding: 8px; background: #2d1515; border-radius: 4px;">
                        <div style="color: #ff8080; font-size: 0.9em; margin-bottom: 4px;">
                            ${config.row.host_type || 'N/A'}/${config.row.port_type || 'N/A'}/${config.row.switch_os || 'N/A'}
                        </div>
                        <div style="color: #ffcccc; font-size: 0.85em;">${config.error}</div>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;

    // Store the cleaned config for copying
    window.currentCombinedConfig = cleanedConfig;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyConfigToClipboard() {
    if (!window.currentCombinedConfig) {
        alert('No config to copy');
        return;
    }

    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(window.currentCombinedConfig).then(() => {
            alert('Configuration copied to clipboard!');
        }).catch(err => {
            console.error('Clipboard API failed:', err);
            // Fallback to old method
            fallbackCopyToClipboard(window.currentCombinedConfig);
        });
    } else {
        // Use fallback method
        fallbackCopyToClipboard(window.currentCombinedConfig);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        document.execCommand('copy');
        alert('Configuration copied to clipboard!');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert('Failed to copy to clipboard. Please copy manually.');
    }
    document.body.removeChild(textArea);
}

function resetUploadArea() {
    // Simply reload the page to reset everything
    window.location.reload();
}

function downloadConfig() {
    if (!window.currentCombinedConfig) {
        alert('No config to download');
        return;
    }

    const blob = new Blob([window.currentCombinedConfig], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'generated_config.txt';
    a.click();
    URL.revokeObjectURL(url);
}

// ========== Template Manager Tab ==========
async function initializeTemplateManager() {
    await loadMetadata();
    await loadTemplates();
}

async function loadMetadata() {
    // Metadata is now managed through modals only, no filter dropdowns to populate
}

async function loadTemplates() {
    try {
        const response = await fetch('/api/templates');
        allTemplates = await response.json();
        displayTemplates(allTemplates);
    } catch (error) {
        console.error('Error loading templates:', error);
    }
}

function searchTemplates() {
    const searchTerm = document.getElementById('templateSearch').value.toLowerCase();

    if (!searchTerm) {
        displayTemplates(allTemplates);
        return;
    }

    const filtered = allTemplates.filter(t => {
        return t.name.toLowerCase().includes(searchTerm) ||
               t.host_type.toLowerCase().includes(searchTerm) ||
               t.port_type.toLowerCase().includes(searchTerm) ||
               t.switch_os.toLowerCase().includes(searchTerm) ||
               (t.description && t.description.toLowerCase().includes(searchTerm));
    });

    displayTemplates(filtered);
}

function displayTemplates(templates) {
    const listContainer = document.getElementById('templateList');

    if (templates.length === 0) {
        listContainer.innerHTML = '<div style="padding: 15px; color: #999; text-align: center;">No templates found</div>';
        return;
    }

    listContainer.innerHTML = templates.map(t => `
        <div class="template-item" onclick="selectTemplate(${t.id}, event)">
            <div class="template-item-title">${t.name}</div>
            <div class="template-item-meta">
                ${t.host_type} | ${t.port_type} | ${t.switch_os}
            </div>
        </div>
    `).join('');
}

async function selectTemplate(templateId, event) {
    try {
        const response = await fetch(`/api/templates/${templateId}`);
        const template = await response.json();

        currentTemplateId = templateId;

        document.querySelectorAll('.template-item').forEach(item => {
            item.classList.remove('selected');
        });
        if (event && event.target) {
            event.target.closest('.template-item').classList.add('selected');
        }

        showTemplateForm(template);
    } catch (error) {
        console.error('Error loading template:', error);
    }
}

async function showTemplateForm(template = null) {
    const formContainer = document.getElementById('templateForm');
    const actionsContainer = document.getElementById('formActions');

    const hostTypes = await fetch('/api/host-types').then(r => r.json());
    const portTypes = await fetch('/api/port-types').then(r => r.json());

    formContainer.innerHTML = `
        <div class="form-group">
            <label class="form-label">Template Name *</label>
            <input type="text" class="form-input" id="templateName" value="${template ? template.name : ''}" required>
        </div>

        <div class="form-group">
            <label class="form-label">Host Type *</label>
            <select class="form-select" id="templateHostType" required>
                ${hostTypes.map(ht => `<option value="${ht}" ${template && template.host_type === ht ? 'selected' : ''}>${ht}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Port Type *</label>
            <select class="form-select" id="templatePortType" onchange="loadOSOptions()" required>
                ${portTypes.map(pt => `<option value="${pt}" ${template && template.port_type === pt ? 'selected' : ''}>${pt}</option>`).join('')}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Switch OS *</label>
            <select class="form-select" id="templateSwitchOS" required>
                ${template ? `<option value="${template.switch_os}" selected>${template.switch_os}</option>` : ''}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <input type="text" class="form-input" id="templateDescription" value="${template ? template.description || '' : ''}">
        </div>

        ${template ? `
        <div class="form-group">
            <label class="form-label">Current Version</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="text" class="form-input" value="v${template.version || 1}" disabled style="flex: 0 0 100px; background: #1a1a1a; color: #999;">
                <button class="button" onclick="showVersionHistory(${template.id})" type="button" style="background: #555; padding: 8px 15px;">View History</button>
            </div>
        </div>
        ` : ''}

        ${template ? `
        <div class="form-group">
            <label class="form-label">Version Description (optional)</label>
            <input type="text" class="form-input" id="versionDescription" placeholder="Describe changes in this version...">
        </div>
        ` : ''}

        <div class="form-group">
            <label class="form-label">Template Content (Jinja2) *</label>
            <textarea class="form-textarea" id="templateContent" rows="20" required>${template ? template.template_content : ''}</textarea>
        </div>
    `;

    actionsContainer.style.display = 'flex';

    if (template) {
        document.getElementById('deleteBtn').style.display = 'block';
        loadOSOptions();
    } else {
        document.getElementById('deleteBtn').style.display = 'none';
        loadOSOptions();
    }
}

async function loadOSOptions() {
    const osSelect = document.getElementById('templateSwitchOS');
    const currentOS = osSelect.value;

    const osTypes = await fetch('/api/switch-os-types').then(r => r.json());

    osSelect.innerHTML = osTypes.map(osType => `
        <option value="${osType}" ${osType === currentOS ? 'selected' : ''}>${osType}</option>
    `).join('');
}

function createNewTemplate() {
    currentTemplateId = null;
    document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('selected');
    });
    showTemplateForm();
}

async function saveTemplate() {
    const name = document.getElementById('templateName').value;
    const hostType = document.getElementById('templateHostType').value;
    const portType = document.getElementById('templatePortType').value;
    const switchOS = document.getElementById('templateSwitchOS').value;
    const description = document.getElementById('templateDescription').value;
    const content = document.getElementById('templateContent').value;
    const versionDescriptionEl = document.getElementById('versionDescription');
    const versionDescription = versionDescriptionEl ? versionDescriptionEl.value : null;

    if (!name || !hostType || !portType || !switchOS || !content) {
        alert('Please fill in all required fields');
        return;
    }

    const data = {
        name,
        host_type: hostType,
        port_type: portType,
        switch_os: switchOS,
        description,
        template_content: content
    };

    // Add version description if updating an existing template
    if (currentTemplateId && versionDescription) {
        data.version_description = versionDescription;
    }

    try {
        let response;
        if (currentTemplateId) {
            response = await fetch(`/api/templates/${currentTemplateId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch('/api/templates', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        const result = await response.json();

        if (result.success) {
            alert('Template saved successfully!');
            await loadTemplates();
            if (!currentTemplateId && result.template_id) {
                currentTemplateId = result.template_id;
            }
        } else {
            alert('Error saving template: ' + result.error);
        }
    } catch (error) {
        alert('Error saving template: ' + error.message);
    }
}

async function deleteTemplate() {
    if (!currentTemplateId) return;

    if (!confirm('Are you sure you want to delete this template?')) return;

    try {
        const response = await fetch(`/api/templates/${currentTemplateId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert('Template deleted successfully!');
            currentTemplateId = null;
            await loadTemplates();
            cancelEdit();
        } else {
            alert('Error deleting template: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting template: ' + error.message);
    }
}

function cancelEdit() {
    currentTemplateId = null;
    document.getElementById('templateForm').innerHTML = `
        <div class="info-box">
            Select a template from the list or create a new one to start editing.
        </div>
    `;
    document.getElementById('formActions').style.display = 'none';
    document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('selected');
    });
}

// ========== Metadata Management ==========

// Host Type Manager
async function showHostTypeManager() {
    document.getElementById('hostTypeModal').style.display = 'flex';
    await loadHostTypesList();
}

function closeHostTypeManager() {
    document.getElementById('hostTypeModal').style.display = 'none';
}

async function loadHostTypesList() {
    try {
        const response = await fetch('/api/host-types');
        const hostTypes = await response.json();

        document.getElementById('hostTypesList').innerHTML = hostTypes.map(ht => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #2d2d30; border-radius: 4px; margin-bottom: 8px;">
                <span style="color: #ccc;">${ht}</span>
                <button onclick="deleteHostType('${ht.replace(/'/g, "\\'")}')" style="background: #f44336; border: none; color: white; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">Delete</button>
            </div>
        `).join('') || '<div style="color: #999; padding: 20px; text-align: center;">No host types</div>';
    } catch (error) {
        console.error('Error loading host types:', error);
        alert('Error loading host types: ' + error.message);
    }
}

async function addHostType() {
    const input = document.getElementById('newHostType');
    const name = input.value.trim();

    if (!name) {
        alert('Please enter a host type name');
        return;
    }

    try {
        const response = await fetch('/api/host-types', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        const result = await response.json();

        if (result.success) {
            input.value = '';
            await loadHostTypesList();
            await loadMetadata();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteHostType(name) {
    if (!confirm(`Delete "${name}"? This may affect existing templates.`)) return;

    try {
        const response = await fetch('/api/host-types/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        const result = await response.json();

        if (result.success) {
            await loadHostTypesList();
            await loadMetadata();
            await loadTemplates();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Vendor Manager
async function showVendorManager() {
    document.getElementById('vendorModal').style.display = 'flex';
    await loadVendorsList();
}

function closeVendorManager() {
    document.getElementById('vendorModal').style.display = 'none';
}

async function loadVendorsList() {
    try {
        const response = await fetch('/api/port-types');
        const vendors = await response.json();

        document.getElementById('vendorsList').innerHTML = vendors.map(v => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #2d2d30; border-radius: 4px; margin-bottom: 8px;">
                <span style="color: #ccc;">${v}</span>
                <button onclick="deleteVendor('${v.replace(/'/g, "\\'")}')" style="background: #f44336; border: none; color: white; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">Delete</button>
            </div>
        `).join('') || '<div style="color: #999; padding: 20px; text-align: center;">No vendors</div>';
    } catch (error) {
        console.error('Error loading vendors:', error);
        alert('Error loading vendors: ' + error.message);
    }
}

async function addVendor() {
    const input = document.getElementById('newVendor');
    const name = input.value.trim();

    if (!name) {
        alert('Please enter a vendor name');
        return;
    }

    try {
        const response = await fetch('/api/port-types', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        const result = await response.json();

        if (result.success) {
            input.value = '';
            await loadVendorsList();
            await loadMetadata();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteVendor(name) {
    if (!confirm(`Delete "${name}"? This may affect existing templates.`)) return;

    try {
        const response = await fetch('/api/port-types/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        const result = await response.json();

        if (result.success) {
            await loadVendorsList();
            await loadMetadata();
            await loadTemplates();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// OS Manager
async function showOSManager() {
    document.getElementById('osModal').style.display = 'flex';
    await loadOSList();
}

function closeOSManager() {
    document.getElementById('osModal').style.display = 'none';
}

async function loadOSList() {
    try {
        const response = await fetch('/api/switch-os-types');
        const osTypes = await response.json();

        document.getElementById('osList').innerHTML = osTypes.map(switch_os => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #2d2d30; border-radius: 4px; margin-bottom: 8px;">
                <span style="color: #ccc;">${switch_os}</span>
                <button onclick="deleteOS('${switch_os.replace(/'/g, "\\'")}')" style="background: #f44336; border: none; color: white; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em;">Delete</button>
            </div>
        `).join('') || '<div style="color: #999; padding: 20px; text-align: center;">No OS types</div>';
    } catch (error) {
        console.error('Error loading OS types:', error);
        alert('Error loading OS types: ' + error.message);
    }
}

async function addOS() {
    const input = document.getElementById('newOS');
    const name = input.value.trim();

    if (!name) {
        alert('Please enter an OS name');
        return;
    }

    try {
        const response = await fetch('/api/switch-os-types', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        const result = await response.json();

        if (result.success) {
            input.value = '';
            await loadOSList();
            await loadMetadata();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteOS(name) {
    if (!confirm(`Delete "${name}"? This may affect existing templates.`)) return;

    try {
        const response = await fetch('/api/switch-os-types/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        const result = await response.json();

        if (result.success) {
            await loadOSList();
            await loadMetadata();
            await loadTemplates();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}


// Resizable panels functionality
document.addEventListener("DOMContentLoaded", () => {
    const resizeHandle = document.getElementById("resizeHandle");
    const leftPanel = document.querySelector(".left-panel");
    const splitView = document.querySelector(".split-view");

    if (resizeHandle && leftPanel && splitView) {
        let isResizing = false;

        resizeHandle.addEventListener("mousedown", (e) => {
            isResizing = true;
            document.body.style.cursor = "col-resize";
            document.body.style.userSelect = "none";
        });

        document.addEventListener("mousemove", (e) => {
            if (!isResizing) return;

            const containerRect = splitView.getBoundingClientRect();
            const newWidth = e.clientX - containerRect.left;
            const percentage = (newWidth / containerRect.width) * 100;

            // Keep between 20% and 80%
            if (percentage >= 20 && percentage <= 80) {
                leftPanel.style.flex = `0 0 ${percentage}%`;
            }
        });

        document.addEventListener("mouseup", () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = "";
                document.body.style.userSelect = "";
            }
        });
    }

    // Config Generator resizer
    const resizer = document.getElementById("resizer");
    const leftPanelConfig = document.getElementById("leftPanel");
    const configGenerator = document.getElementById("config-generator");

    if (resizer && leftPanelConfig && configGenerator) {
        let isResizingConfig = false;

        resizer.addEventListener("mousedown", (e) => {
            isResizingConfig = true;
            document.body.style.cursor = "col-resize";
            document.body.style.userSelect = "none";
            e.preventDefault();
        });

        document.addEventListener("mousemove", (e) => {
            if (!isResizingConfig) return;

            const containerRect = configGenerator.getBoundingClientRect();
            const newWidth = e.clientX - containerRect.left;
            const percentage = (newWidth / containerRect.width) * 100;

            // Keep between 20% and 80%
            if (percentage >= 20 && percentage <= 80) {
                leftPanelConfig.style.width = `${percentage}%`;
            }
        });

        document.addEventListener("mouseup", () => {
            if (isResizingConfig) {
                isResizingConfig = false;
                document.body.style.cursor = "";
                document.body.style.userSelect = "";
            }
        });
    }
});

// ========== Version History Functions ==========
async function showVersionHistory(templateId) {
    try {
        const response = await fetch(`/api/templates/${templateId}/versions`);
        const versions = await response.json();

        const modal = document.getElementById('versionHistoryModal');
        const listContainer = document.getElementById('versionHistoryList');

        if (versions.length === 0) {
            listContainer.innerHTML = '<div style="color: #999; padding: 20px; text-align: center;">No version history available</div>';
        } else {
            listContainer.innerHTML = versions.map(v => `
                <div style="background: #2d2d30; border-radius: 4px; padding: 15px; margin-bottom: 10px; border-left: 3px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <span style="color: #667eea; font-weight: bold; font-size: 1.1em;">Version ${v.version}</span>
                            <span style="color: #999; margin-left: 10px; font-size: 0.9em;">${new Date(v.created_at).toLocaleString()}</span>
                        </div>
                        <button class="button" onclick="restoreVersion(${templateId}, ${v.version})" style="background: #4CAF50; padding: 6px 12px; font-size: 0.85em;">
                            Restore
                        </button>
                    </div>
                    ${v.version_description ? `<div style="color: #ccc; margin-bottom: 8px; font-style: italic;">${escapeHtml(v.version_description)}</div>` : ''}
                    ${v.description ? `<div style="color: #999; font-size: 0.9em;"><strong>Template Description:</strong> ${escapeHtml(v.description)}</div>` : ''}
                    <div style="color: #999; font-size: 0.85em; margin-top: 5px;">
                        <strong>Config:</strong> ${escapeHtml(v.host_type)} / ${escapeHtml(v.port_type)} / ${escapeHtml(v.switch_os)}
                    </div>
                </div>
            `).join('');
        }

        modal.style.display = 'flex';
    } catch (error) {
        console.error('Error loading version history:', error);
        alert('Error loading version history: ' + error.message);
    }
}

async function restoreVersion(templateId, version) {
    if (!confirm(`Are you sure you want to restore to version ${version}? This will create a new version with the content from version ${version}.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/templates/${templateId}/restore/${version}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert(`Successfully restored to version ${version}!`);
            closeVersionHistory();
            await loadTemplates();
            if (currentTemplateId === templateId) {
                await selectTemplate(templateId);
            }
        } else {
            alert('Error restoring version: ' + result.error);
        }
    } catch (error) {
        console.error('Error restoring version:', error);
        alert('Error restoring version: ' + error.message);
    }
}

function closeVersionHistory() {
    document.getElementById('versionHistoryModal').style.display = 'none';
}

