import sqlite3
import json
from datetime import datetime

class Database:
    def __init__(self, db_path='data/templates.db'):
        import os
        os.makedirs(os.path.dirname(db_path), exist_ok=True)
        self.db_path = db_path
        self.init_db()

    def get_connection(self):
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn

    def init_db(self):
        conn = self.get_connection()
        cursor = conn.cursor()

        # Check if templates table exists and needs migration
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='templates'")
        table_exists = cursor.fetchone()

        if table_exists:
            # Check if we need to migrate from old schema
            cursor.execute("PRAGMA table_info(templates)")
            columns = cursor.fetchall()

            # Check constraints - if old schema, migrate
            cursor.execute("SELECT sql FROM sqlite_master WHERE type='table' AND name='templates'")
            table_sql = cursor.fetchone()
            if table_sql and 'UNIQUE(host_type, vendor, os, name)' in table_sql[0]:
                # Migrate from old schema
                print("Migrating templates table to new schema...")
                cursor.execute('''
                    CREATE TABLE templates_new (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        host_type TEXT NOT NULL,
                        vendor TEXT NOT NULL,
                        os TEXT NOT NULL,
                        template_content TEXT NOT NULL,
                        description TEXT,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        UNIQUE(host_type, vendor, os)
                    )
                ''')

                # Copy data - keep only the first template for each combination
                cursor.execute('''
                    INSERT INTO templates_new (id, name, host_type, vendor, os, template_content, description, created_at, updated_at)
                    SELECT MIN(id), name, host_type, vendor, os, template_content, description, created_at, updated_at
                    FROM templates
                    GROUP BY host_type, vendor, os
                ''')

                cursor.execute('DROP TABLE templates')
                cursor.execute('ALTER TABLE templates_new RENAME TO templates')
                print("Migration complete!")

        # Check if we need to migrate from vendor/os to port_type/switch_os
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='templates'")
        table_exists = cursor.fetchone()

        if table_exists:
            cursor.execute("PRAGMA table_info(templates)")
            columns = {col[1]: col for col in cursor.fetchall()}

            if 'vendor' in columns or 'os' in columns:
                print("Migrating templates table from vendor/os to port_type/switch_os...")
                cursor.execute('''
                    CREATE TABLE templates_migrated (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        host_type TEXT NOT NULL,
                        port_type TEXT NOT NULL,
                        switch_os TEXT NOT NULL,
                        template_content TEXT NOT NULL,
                        description TEXT,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        UNIQUE(host_type, port_type, switch_os)
                    )
                ''')

                cursor.execute('''
                    INSERT INTO templates_migrated (id, name, host_type, port_type, switch_os, template_content, description, created_at, updated_at)
                    SELECT id, name, host_type, vendor, os, template_content, description, created_at, updated_at
                    FROM templates
                ''')

                cursor.execute('DROP TABLE templates')
                cursor.execute('ALTER TABLE templates_migrated RENAME TO templates')
                print("Templates table migration complete!")

        # Templates table - ONE template per host_type/port_type/switch_os combination
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS templates (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                host_type TEXT NOT NULL,
                port_type TEXT NOT NULL,
                switch_os TEXT NOT NULL,
                template_content TEXT NOT NULL,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(host_type, port_type, switch_os)
            )
        ''')

        # Host types table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS host_types (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL,
                description TEXT
            )
        ''')

        # Migrate vendors table to port_types
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='vendors'")
        if cursor.fetchone():
            print("Migrating vendors table to port_types...")
            cursor.execute('ALTER TABLE vendors RENAME TO port_types')
            print("Vendors table renamed to port_types!")

        # Port types table (formerly vendors)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS port_types (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL
            )
        ''')

        # Migrate os_types to switch_os_types
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='os_types'")
        if cursor.fetchone():
            print("Migrating os_types table to switch_os_types...")
            cursor.execute('ALTER TABLE os_types RENAME TO switch_os_types')
            print("OS types table renamed to switch_os_types!")

        # Switch OS types table (formerly os_types)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS switch_os_types (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE
            )
        ''')

        # Template fields table (for dynamic Excel column generation)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS template_fields (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                template_id INTEGER NOT NULL,
                field_name TEXT NOT NULL,
                field_type TEXT NOT NULL,
                required BOOLEAN DEFAULT 1,
                default_value TEXT,
                FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE
            )
        ''')

        # No default values - user will create their own host types, vendors (port types), and OS types

        conn.commit()
        conn.close()

    # Template CRUD operations
    def create_template(self, name, host_type, port_type, switch_os, template_content, description='', fields=None):
        conn = self.get_connection()
        cursor = conn.cursor()

        try:
            cursor.execute('''
                INSERT INTO templates (name, host_type, port_type, switch_os, template_content, description)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (name, host_type, port_type, switch_os, template_content, description))

            template_id = cursor.lastrowid

            # Add template fields if provided
            if fields:
                for field in fields:
                    cursor.execute('''
                        INSERT INTO template_fields (template_id, field_name, field_type, required, default_value)
                        VALUES (?, ?, ?, ?, ?)
                    ''', (template_id, field['name'], field['type'], field.get('required', True), field.get('default', '')))

            conn.commit()
            return template_id
        except sqlite3.IntegrityError as e:
            conn.rollback()
            raise ValueError(f'A template already exists for {host_type}/{port_type}/{switch_os}. Only one template is allowed per combination.')
        finally:
            conn.close()

    def get_template(self, template_id):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM templates WHERE id = ?', (template_id,))
        template = cursor.fetchone()
        conn.close()
        return dict(template) if template else None

    def get_templates_by_criteria(self, host_type=None, vendor=None, os=None):
        conn = self.get_connection()
        cursor = conn.cursor()

        query = 'SELECT * FROM templates WHERE 1=1'
        params = []

        if host_type:
            query += ' AND host_type = ?'
            params.append(host_type)
        if vendor:
            query += ' AND vendor = ?'
            params.append(vendor)
        if os:
            query += ' AND os = ?'
            params.append(os)

        cursor.execute(query, params)
        templates = cursor.fetchall()
        conn.close()
        return [dict(t) for t in templates]

    def get_all_templates(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM templates ORDER BY host_type, vendor, os, name')
        templates = cursor.fetchall()
        conn.close()
        return [dict(t) for t in templates]

    def update_template(self, template_id, **kwargs):
        conn = self.get_connection()
        cursor = conn.cursor()

        try:
            allowed_fields = ['name', 'host_type', 'vendor', 'os', 'template_content', 'description']
            updates = []
            values = []

            for key, value in kwargs.items():
                if key in allowed_fields:
                    updates.append(f'{key} = ?')
                    values.append(value)

            if updates:
                values.append(datetime.now())
                values.append(template_id)
                query = f"UPDATE templates SET {', '.join(updates)}, updated_at = ? WHERE id = ?"
                cursor.execute(query, values)

            conn.commit()
        except sqlite3.IntegrityError as e:
            conn.rollback()
            host_type = kwargs.get('host_type', 'unknown')
            vendor = kwargs.get('vendor', 'unknown')
            os = kwargs.get('os', 'unknown')
            raise ValueError(f'A template already exists for {host_type}/{vendor}/{os}. Only one template is allowed per combination.')
        finally:
            conn.close()

    def delete_template(self, template_id):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('DELETE FROM templates WHERE id = ?', (template_id,))
        conn.commit()
        conn.close()

    # Get metadata
    def get_host_types(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT name FROM host_types ORDER BY name')
        results = cursor.fetchall()
        conn.close()
        return [r['name'] for r in results]

    def get_vendors(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT name FROM vendors ORDER BY name')
        results = cursor.fetchall()
        conn.close()
        return [r['name'] for r in results]

    def get_os_types(self, vendor=None):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT name FROM os_types ORDER BY name')
        results = cursor.fetchall()
        conn.close()
        return [r['name'] for r in results]

    def get_template_fields(self, template_id):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM template_fields WHERE template_id = ?', (template_id,))
        fields = cursor.fetchall()
        conn.close()
        return [dict(f) for f in fields]

    # Metadata management
    def add_host_type(self, name, description=''):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('INSERT INTO host_types (name, description) VALUES (?, ?)', (name, description))
        conn.commit()
        conn.close()

    def remove_host_type(self, name):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('DELETE FROM host_types WHERE name = ?', (name,))
        conn.commit()
        conn.close()

    def add_vendor(self, name):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('INSERT INTO vendors (name) VALUES (?)', (name,))
        conn.commit()
        conn.close()

    def remove_vendor(self, name):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('DELETE FROM vendors WHERE name = ?', (name,))
        conn.commit()
        conn.close()

    def add_os_type(self, name):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('INSERT INTO os_types (name) VALUES (?)', (name,))
        conn.commit()
        conn.close()

    def remove_os_type(self, name):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('DELETE FROM os_types WHERE name = ?', (name,))
        conn.commit()
        conn.close()
